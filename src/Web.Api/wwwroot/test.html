<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-AI Chat Interface</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.8.0/styles/atom-one-dark.min.css">
    <style>
        :root {
            --primary-color: #5b86e5; /* Vibrant blue for accents */
            --secondary-color: #36d1dc; /* Teal for user messages */
            --bg-color: #121417; /* Darker background for better contrast */
            --text-color: #e9eef2; /* Lighter text for better readability */
            --thinking-bg: #1c2329; /* Darker for thinking messages for better contrast */
            --thinking-border: #4285f4; /* Brighter blue border for thinking */
            --user-msg-bg: #4a6bdf; /* Brighter blue for user messages */
            --user-msg-color: #ffffff; /* White text for user messages */
            --ai-msg-bg: #1c2329; /* Darker for AI messages */
            --ai-msg-color: #e9eef2; /* Lighter text for AI messages */
            --ai-msg-shadow: rgba(0, 0, 0, 0.2); /* Stronger shadow */
            --code-bg: #0f1419; /* Darker code background */
            --input-bg: #1c2329; /* Darker input background */
            --header-bg: linear-gradient(135deg, #4a6bdf, #8e54e9); /* Brighter gradient */
            --border-radius: 12px; /* Rounded borders */
        }
    
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 16px;
            line-height: 1.6;
        }
    
        .container {
            width: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-color);
            border-radius: 0;
            overflow: hidden;
        }
    
        .header {
            background: var(--header-bg);
            color: white;
            padding: 1.25rem;
            text-align: center;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    
        .header h1 {
            margin: 0;
            font-size: 1.75rem; /* Slightly smaller header */
        }
    
        .header-logo {
            font-size: 1.75rem; /* Smaller logo */
            margin-right: 1rem;
        }
    
        .settings-panel {
            padding: 1rem;
            background-color: #131820; /* Darker than main background */
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
    
        .input-group {
            flex: 1;
            min-width: 200px;
        }
    
        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #b0bec5;
            font-size: 0.95rem; /* Smaller label */
        }
    
        .input-group input,
        .input-group select,
        .input-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #455a64;
            border-radius: 0.5rem;
            box-sizing: border-box;
            font-size: 0.95rem; /* Smaller input text */
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
    
        .input-group input:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(91, 134, 229, 0.25);
            outline: none;
        }
    
        .button-group {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
    
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            overflow: hidden;
            background-color: var(--bg-color);
        }
    
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            background-color: var(--bg-color);
            border-radius: 0;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            position: relative;
        }
    
        .message {
            position: relative;
            max-width: 80%;
            padding: 1.25rem;
            border-radius: 1rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 0.3s ease;
            overflow: hidden;
            font-size: 1rem;
            line-height: 1.6;
            word-break: break-word;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
    
        .user {
            align-self: flex-end;
            background-color: var(--user-msg-bg);
            color: var(--user-msg-color);
            border-bottom-right-radius: 0.25rem;
            font-weight: 500;
        }
    
        .ai {
            align-self: flex-start;
            background-color: var(--ai-msg-bg);
            color: var(--ai-msg-color);
            border-bottom-left-radius: 0.25rem;
            border-left: 3px solid var(--primary-color);
            width: auto;
            max-width: 80%;
        }
    
        .thinking {
            position: relative;
            margin: 1rem 0;
            padding: 1.25rem;
            background-color: rgba(33, 150, 243, 0.05);
            border-left: 4px solid var(--primary-color);
            border-radius: 0.5rem;
            max-width: 85%;
            align-self: flex-start;
            font-style: italic;
            color: #cfd8dc;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }
    
        .thinking-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background-color: rgba(66, 133, 244, 0.15);
            color: #90caf9;
            padding: 0.4rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
            font-style: normal;
            font-weight: 500;
        }
    
        .thinking-badge i {
            color: #64b5f6;
            animation: pulse 1.5s infinite;
        }
    
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    
        .message-content {
            word-wrap: break-word;
            line-height: 1.6;
            width: 100%;
            overflow: visible;
        }
    
        .message-content p {
            margin: 0.5rem 0;
        }
    
        .message-content p:first-child {
            margin-top: 0;
        }
    
        .message-content p:last-child {
            margin-bottom: 0;
        }
    
        .message-content pre {
            margin: 0.75rem 0;
            padding: 1rem;
            background-color: var(--code-bg);
            border-radius: 0.5rem;
            overflow-x: auto;
            color: #e0e0e0;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            white-space: pre-wrap;
            word-break: break-word;
        }
    
        .message-content code {
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 0.9rem;
        }
    
        .message-attachments {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
        }
    
        .attachment {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            background-color: #3b4650;
            max-width: 250px;
            transition: background-color 0.2s;
        }
    
        .attachment:hover {
            background-color: #455a64;
        }
    
        .attachment-icon {
            margin-right: 0.5rem;
            font-size: 1.25rem;
            color: #90caf9;
        }
    
        .attachment-info {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            font-size: 0.9rem;
            color: #eceff1;
        }
    
        .attachment-actions {
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
        }
    
        .attachment-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #90caf9;
            font-size: 0.9rem;
            padding: 0.3rem;
            border-radius: 0.25rem;
            transition: color 0.2s, background-color 0.2s;
        }
    
        .attachment-btn:hover {
            color: var(--primary-color);
            background-color: rgba(91, 134, 229, 0.1);
        }
    
        .file-upload {
            display: flex;
            align-items: center;
            margin-right: 0.5rem;
        }
    
        .file-upload-btn {
            background-color: #546e7a;
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    
        .file-upload-btn:hover {
            background-color: #455a64;
        }
    
        .file-upload-input {
            display: none;
        }
    
        .message-info {
            font-size: 0.85rem;
            margin-top: 0.75rem;
            color: #90a4ae;
            display: flex;
            justify-content: space-between;
        }
    
        .message-actions {
            position: absolute;
            right: 0.5rem;
            top: 0.5rem;
            display: flex;
            gap: 0.3rem;
            opacity: 0;
            transition: opacity 0.2s ease;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 0.2rem;
            border-radius: 0.5rem;
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
        }
        
        .message:hover .message-actions {
            opacity: 1;
        }
    
        .action-button {
            background: none;
            border: none;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            padding: 0.3rem;
            border-radius: 0.25rem;
            transition: color 0.2s, background-color 0.2s;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    
        .action-button:hover {
            background-color: rgba(255, 255, 255, 0.15);
            color: #ffffff;
        }
    
        .ai .action-button, .thinking .action-button {
            color: rgba(144, 202, 249, 0.7);
        }
    
        .input-area {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            background-color: rgba(28, 35, 41, 0.95); /* Slightly transparent */
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: 0;
            position: relative; /* Needed for positioning */
            -webkit-backdrop-filter: blur(10px); /* Safari support */
            backdrop-filter: blur(10px); /* Modern blur effect */
            z-index: 10; /* Stay above content */
        }
    
        .input-container {
            flex: 1;
            position: relative;
        }
    
        .input-area textarea {
            width: 100%;
            padding: 1rem 3.5rem 1rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            resize: vertical;
            min-height: 60px;
            max-height: 200px;
            font-family: inherit;
            font-size: 1rem;
            background-color: var(--input-bg);
            color: var(--text-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: border-color 0.2s, box-shadow 0.2s;
        }
    
        .input-area textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(91, 134, 229, 0.25);
            outline: none;
        }
    
        .input-actions {
            position: absolute;
            right: 1rem;
            bottom: 1rem;
            display: flex;
            gap: 0.5rem;
        }
    
        .action-icon {
            background: none;
            border: none;
            cursor: pointer;
            color: #90a4ae;
            font-size: 1.25rem;
            transition: color 0.2s;
            padding: 0.3rem;
        }
    
        .action-icon:hover {
            color: var(--primary-color);
        }
    
        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
    
        .btn-primary:hover {
            background-color: #4a72c9;
            transform: translateY(-1px);
        }
    
        .btn-secondary {
            background-color: #546e7a;
            color: white;
        }
    
        .btn-secondary:hover {
            background-color: #455a64;
            transform: translateY(-1px);
        }
    
        .btn-danger {
            background-color: #ef5350;
            color: white;
        }
    
        .btn-danger:hover {
            background-color: #e53935;
            transform: translateY(-1px);
        }
    
        button:disabled {
            background-color: #455a64;
            cursor: not-allowed;
            transform: none;
            opacity: 0.7;
        }
    
        .stop-button {
            background-color: #ef5350;
        }
    
        .stop-button:hover {
            background-color: #e53935;
        }
    
        .send-button {
            border-radius: 50%;
            width: 50px;
            height: 50px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background-color: var(--primary-color);
        }
    
        .animation-pulse {
            animation: pulse 1.5s infinite;
        }
    
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    
        .system-message {
            background-color: rgba(28, 35, 41, 0.9);
            color: #e0e0e0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin: 1rem 0;
            text-align: center;
            font-size: 0.95rem;
            animation: fadeIn 0.5s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    
        .success-message {
            background-color: rgba(46, 125, 50, 0.2);
            border-color: rgba(46, 125, 50, 0.3);
            color: #a5d6a7;
        }
    
        .error-message {
            background-color: rgba(183, 28, 28, 0.2);
            border-color: rgba(183, 28, 28, 0.3);
            color: #ef9a9a;
        }
    
        .info-message {
            background-color: rgba(13, 71, 161, 0.2);
            border-color: rgba(13, 71, 161, 0.3);
            color: #90caf9;
        }
    
        .agent-selection {
            background-color: #1c2329;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin: 0.75rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    
        .agent-selection h3 {
            margin: 0 0 1rem 0;
            color: #e0e0e0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    
        .agent-selection h3 i {
            color: var(--primary-color);
        }
    
        .agent-option {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    
        .agent-option:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
    
        .agent-option input {
            margin-right: 1rem;
            transform: scale(1.1);
        }
    
        .agent-option label {
            font-weight: 500;
            font-size: 1rem;
            color: #e0e0e0;
            cursor: pointer;
            flex: 1;
        }
    
        .agent-option label .text-muted {
            color: #90a4ae !important;
            font-size: 0.9rem;
            margin-top: 0.25rem;
            display: block;
        }
    
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1.5rem;
            color: #90caf9;
            font-style: italic;
        }
    
        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(66, 133, 244, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }
    
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    
        .code-block {
            position: relative;
        }
    
        .code-block .copy-button {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            color: #b0bec5;
            border: none;
            border-radius: 0.25rem;
            padding: 0.3rem 0.6rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
    
        .code-block .copy-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
    
        .code-block .language-label {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background-color: rgba(255, 255, 255, 0.1);
            color: #b0bec5;
            border-radius: 0.25rem;
            padding: 0.3rem 0.6rem;
            font-size: 0.85rem;
        }
    
        /* Prevent horizontal overflow issues */
        .message-content img {
            max-width: 100%;
            height: auto;
        }
    
        /* Light mode styles */
        .light-mode {
            --bg-color: #f5f7fa;
            --text-color: #263238;
            --thinking-bg: #e3f2fd;
            --thinking-border: #90caf9;
            --ai-msg-bg: #ffffff;
            --ai-msg-color: #263238;
            --ai-msg-shadow: rgba(0, 0, 0, 0.05);
            --input-bg: #ffffff;
            --user-msg-bg: #4dd0e1;
            --user-msg-color: #1a2526;
        }
    
        .light-mode .container {
            background-color: #ffffff;
        }
    
        .light-mode .settings-panel {
            background-color: #ffffff;
            border-bottom: 1px solid #e0e0e0;
        }
    
        .light-mode .input-group label {
            color: #455a64;
        }
    
        .light-mode .input-group input,
        .light-mode .input-group select,
        .light-mode .input-group textarea {
            background-color: var(--input-bg);
            border-color: #b0bec5;
            color: #263238;
        }
    
        .light-mode .input-area textarea {
            background-color: var(--input-bg);
            border-color: #b0bec5;
            color: #263238;
        }
    
        .light-mode .agent-selection {
            background-color: #ffffff;
        }
        
        .light-mode .agent-option {
            color: #263238;
        }
        
        .light-mode .agent-option:hover {
            background-color: #eceff1;
        }
        
        .light-mode .agent-option label {
            color: #263238;
        }
        
        .light-mode .agent-option label .text-muted {
            color: #78909c !important;
        }
    
        .light-mode .agent-selection h3 {
            color: #455a64;
        }
    
        .light-mode .input-area {
            background-color: #eceff1;
            border-top: 1px solid #e0e0e0;
        }
    
        .light-mode .system-message {
            background-color: #ef9a9a;
            color: #b71c1c;
        }
    
        .light-mode .success-message {
            background-color: #a5d6a7;
            color: #1b5e20;
        }
    
        .light-mode .info-message {
            background-color: #90caf9;
            color: #0d47a1;
        }
    
        .light-mode .thinking {
            color: #455a64;
        }
        
        .light-mode .thinking-badge {
            background-color: #bbdefb;
            color: #1976d2;
        }
        
        .light-mode .action-icon {
            color: #78909c;
        }
        
        .light-mode .message-info {
            color: #78909c;
        }
        
        .light-mode .attachment {
            background-color: #eceff1;
        }
        
        .light-mode .attachment:hover {
            background-color: #e0e0e0;
        }
        
        .light-mode .attachment-icon {
            color: #546e7a;
        }
        
        .light-mode .attachment-info {
            color: #546e7a;
        }
        
        .light-mode .attachment-btn {
            color: #546e7a;
        }
    
        /* Tablet and smaller screens (up to 768px) */
        @media (max-width: 768px) {
            body {
                font-size: 14px; /* Even smaller base font size */
            }
            
            .header h1 {
                font-size: 1.25rem; /* Further reduce header title size */
            }
            
            .settings-panel {
                padding: 0.75rem;
                gap: 0.75rem;
            }
            
            .input-group label {
                font-size: 0.9rem;
            }
            
            .input-group input,
            .input-group select,
            .input-group textarea {
                font-size: 0.9rem;
                padding: 0.5rem;
            }
            
            .message {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .input-area {
                padding: 0.75rem;
            }
            
            .input-area textarea {
                font-size: 0.9rem;
                padding: 0.75rem 3rem 0.75rem 0.75rem;
            }
            
            .send-button {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
            
            .action-icon {
                font-size: 1rem;
            }
        }
    
        /* Mobile phones (up to 480px) */
        @media (max-width: 480px) {
            .header {
                padding: 0.75rem;
            }
            
            .header-logo {
                font-size: 1.25rem;
                margin-right: 0.5rem;
            }
            
            .settings-panel {
                flex-direction: column;
            }
            
            .input-group {
                min-width: 100%;
            }
            
            .button-group {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            button {
                width: 100%;
            }
            
            .message {
                max-width: 90%;
            }
            
            .input-area {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .input-container {
                width: 100%;
            }
            
            .send-button, .stop-button {
                width: 100%;
                border-radius: 0.5rem;
            }
        }
    
        /* Message actions for touch devices */
        @media (max-width: 768px) {
            .message-actions {
                display: block;
                position: static;
                margin-top: 0.5rem;
            }
            
            .action-button {
                background-color: rgba(0, 0, 0, 0.05);
                padding: 0.5rem;
            }
            
            .light-mode .action-button {
                background-color: rgba(0, 0, 0, 0.05);
            }
        }
    
        /* Code block adjustments for smaller screens */
        @media (max-width: 768px) {
            .message-content pre {
                font-size: 0.85rem;
                white-space: pre-wrap;
                word-break: break-word;
            }
            
            .message-content code {
                font-size: 0.85rem;
            }
        }
    
        /* Table styles for markdown content */
        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 0.25rem;
            overflow: hidden;
        }
        
        .message-content th, 
        .message-content td {
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0.75rem;
            text-align: left;
        }
        
        .message-content th {
            background-color: rgba(0, 0, 0, 0.3);
            color: #e0e0e0;
            font-weight: 600;
        }
        
        .message-content tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.03);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="d-flex align-items-center">
            <i class="fas fa-robot header-logo"></i>
            <h1>Multi-AI Chat Interface</h1>
        </div>
        <div>
            <button id="themeSwitcher" class="btn-secondary" aria-label="Toggle Dark Mode">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <div class="settings-panel">
        <div class="input-group">
            <label for="userToken">Authentication Token</label>
            <input type="text" id="userToken" placeholder="Enter your auth token" />
        </div>
        <div class="input-group">
            <label for="chatSessionId">Chat Session ID</label>
            <input type="text" id="chatSessionId" placeholder="Enter chat session ID" />
        </div>
        <div class="input-group">
            <label for="modelSelect">AI Model</label>
            <select id="modelSelect">
                <option value="" disabled selected>Select AI Model</option>
            </select>
        </div>
        <div class="input-group">
            <label for="enableThinking">Enable Thinking</label>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="enableThinking" />
            </div>
        </div>
        <div class="button-group">
            <button id="connectButton" class="btn-primary" onclick="joinChatSession()">
                <i class="fas fa-plug"></i> Connect
            </button>
            <button id="createSessionButton" class="btn-secondary" onclick="createNewSession()">
                <i class="fas fa-plus-circle"></i> New Session
            </button>
        </div>
    </div>

    <div id="agentSelectionPanel" class="agent-selection" style="display: none;">
        <h3><i class="fas fa-user-astronaut"></i> Select AI Agent</h3>
        <div id="agentOptions"></div>
    </div>

    <div class="chat-area">
        <div id="messages" class="messages">
            <div class="system-message info-message">
                <i class="fas fa-info-circle"></i> Connect to start chatting with AI
            </div>
        </div>
        <div class="input-area">
            <div class="input-container">
                <textarea id="messageInput" placeholder="Type your message here..." disabled></textarea>
                <div class="input-actions">
                    <button class="action-icon" id="fileButton" aria-label="Attach File">
                        <i class="fas fa-paperclip"></i>
                        <input type="file" id="fileUpload" class="file-upload-input" />
                    </button>
                </div>
            </div>
            <button id="sendButton" class="btn-primary send-button" onclick="sendMessage()" disabled aria-label="Send Message">
                <i class="fas fa-paper-plane"></i>
            </button>
            <button id="stopButton" class="btn-danger" onclick="stopCurrentResponse()" disabled style="display: none;">
                <i class="fas fa-stop"></i> Stop
            </button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.11/signalr.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.8.0/build/highlight.min.js"></script>
<script>
    // Configure marked with highlight.js for code highlighting
    marked.setOptions({
        highlight: function(code, language) {
            if (language && hljs.getLanguage(language)) {
                return hljs.highlight(code, { language: language }).value;
            } else {
                return hljs.highlightAuto(code).value;
            }
        },
        breaks: true,
        gfm: true
    });

    // Global variables
    let connection;
    let currentResponseMessageId = null;
    let isReceivingResponse = false;
    let lastUserMessageId = null;
    let aiModels = [];
    let aiAgents = [];
    let currentThinkingMessageId = null;
    let darkModeEnabled = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;

    // DOM Elements
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const stopButton = document.getElementById('stopButton');
    const messagesContainer = document.getElementById('messages');
    const fileButton = document.getElementById('fileButton');
    const fileUpload = document.getElementById('fileUpload');
    const themeSwitcher = document.getElementById('themeSwitcher');

    // Initialize on page load
    window.onload = async () => {
        await fetchAiModels();
        await fetchAiAgents();
        
        // Restore token from localStorage if available
        const savedToken = localStorage.getItem('userToken');
        if (savedToken) {
            document.getElementById('userToken').value = savedToken;
        }
        
        document.getElementById('agentSelectionPanel').style.display = 'block';
        
        // Setup file upload event listener
        fileButton.addEventListener('click', () => fileUpload.click());
        fileUpload.addEventListener('change', uploadFile);
        
        // Setup message input autosizing
        messageInput.addEventListener('input', autoResizeTextarea);
        
        // Theme switcher
        themeSwitcher.addEventListener('click', toggleDarkMode);
        updateThemeIcon();
        
        // Set initial dark/light mode
        const savedDarkMode = localStorage.getItem('darkMode');
        darkModeEnabled = savedDarkMode === null ? true : savedDarkMode === 'enabled';
        document.body.classList.toggle('light-mode', !darkModeEnabled);
        updateThemeIcon();
    };

    function toggleDarkMode() {
        darkModeEnabled = !darkModeEnabled;
        document.body.classList.toggle('light-mode', !darkModeEnabled);
        localStorage.setItem('darkMode', darkModeEnabled ? 'enabled' : 'disabled');
        updateThemeIcon();
    }

    function updateThemeIcon() {
        themeSwitcher.innerHTML = darkModeEnabled ? 
            '<i class="fas fa-sun"></i>' : 
            '<i class="fas fa-moon"></i>';
    }

    function autoResizeTextarea() {
        messageInput.style.height = 'auto';
        messageInput.style.height = (messageInput.scrollHeight) + 'px';
    }

    async function fetchAiModels() {
        try {
            const token = localStorage.getItem('userToken') || '';
            const response = await fetch('/api/AiModel/GetAll', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                aiModels = await response.json();
                populateModelSelect(aiModels);
            }
        } catch (error) {
            console.error('Error fetching AI models:', error);
            showSystemMessage('Failed to load AI models', 'error');
        }
    }

    async function fetchAiAgents() {
        try {
            const token = localStorage.getItem('userToken') || '';
            const response = await fetch('/api/AiAgent/GetAll', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (response.ok) {
                aiAgents = await response.json();
                populateAgentOptions(aiAgents);
            }
        } catch (error) {
            console.error('Error fetching AI agents:', error);
        }
    }

    function populateModelSelect(models) {
        const select = document.getElementById('modelSelect');
        select.innerHTML = '<option value="" disabled selected>Select AI Model</option>';
        models.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.name;
            select.appendChild(option);
        });
    }

    function populateAgentOptions(agents) {
        const container = document.getElementById('agentOptions');
        container.innerHTML = `
            <div class="agent-option">
                <input type="radio" id="agent-none" name="agent" value="none" checked>
                <label for="agent-none">No Agent (Default Model)</label>
            </div>
        `;
        
        if (!agents || agents.length === 0) {
            return;
        }
        
        agents.forEach(agent => {
            const option = document.createElement('div');
            option.className = 'agent-option';
            option.innerHTML = `
                <input type="radio" id="agent-${agent.id}" name="agent" value="${agent.id}">
                <label for="agent-${agent.id}">
                    <strong>${agent.name}</strong>
                    <p class="mb-0 text-muted small">${agent.description || 'No description'}</p>
                </label>
            `;
            container.appendChild(option);
        });
    }

    function joinChatSession() {
        const userToken = document.getElementById('userToken').value;
        const chatSessionId = document.getElementById('chatSessionId').value;

        if (!userToken || !chatSessionId) {
            showSystemMessage('Please enter both Auth Token and Chat Session ID', 'error');
            return;
        }

        localStorage.setItem('userToken', userToken);
        messagesContainer.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div> Connecting...</div>';

        if (connection) connection.stop();

        connection = new signalR.HubConnectionBuilder()
            .withUrl(`/chatHub?access_token=${userToken}`)
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();

        setupSignalREventHandlers();

        connection.start()
            .then(() => connection.invoke('JoinChatSession', chatSessionId))
            .then(() => {
                showSystemMessage('Connected! Start chatting.', 'success');
                enableChatInterface();
                loadChatHistory(chatSessionId, userToken);
            })
            .catch(err => {
                console.error('Connection error:', err);
                showSystemMessage('Connection failed. Check credentials.', 'error');
                disableChatInterface();
            });
    }

    function setupSignalREventHandlers() {
        connection.onreconnecting(() => {
            showSystemMessage('Reconnecting...', 'info');
            disableChatInterface();
        });

        connection.onreconnected(() => {
            showSystemMessage('Connection restored!', 'success');
            enableChatInterface();
        });

        connection.onclose(() => {
            showSystemMessage('Connection closed. Refresh to reconnect.', 'error');
            disableChatInterface();
        });

        connection.on('ReceiveMessage', (message) => {
            if (!message.isFromAi) {
                addMessageToChat(message.content, false, message.messageId);
                lastUserMessageId = message.messageId;
            } else {
                currentResponseMessageId = message.messageId;
                isReceivingResponse = true;
                updateStopButton(true);
            }
        });

        connection.on('ReceiveMessageChunk', (messageId, chunk) => {
            updateMessageChunk(messageId, chunk);
        });

        connection.on('ReceiveThinkingChunk', (messageId, chunk) => {
            updateThinkingChunk(messageId, chunk);
        });

        connection.on('ResponseCompleted', (messageId) => {
            if (messageId === currentResponseMessageId) {
                isReceivingResponse = false;
                currentResponseMessageId = null;
                currentThinkingMessageId = null;
                updateStopButton(false);
                addCodeBlockActions();
            }
        });

        connection.on('ResponseStopped', (messageId) => {
            if (messageId === currentResponseMessageId) {
                isReceivingResponse = false;
                currentResponseMessageId = null;
                currentThinkingMessageId = null;
                updateStopButton(false);
                appendToMessage(messageId, ' [Stopped]');
                addCodeBlockActions();
            }
        });

        connection.on('Error', (error) => {
            showSystemMessage(`Error: ${error}`, 'error');
        });
        
        connection.on('ReceiveFile', (fileAttachment) => {
            addFileAttachmentToMessage(fileAttachment.messageId, fileAttachment);
        });

        connection.on('MessageEditConfirmed', (messageId) => {
            showSystemMessage('Message edited successfully', 'success');
        });
        
        connection.on('RegenerationStarted', (messageId) => {
            showSystemMessage('Regenerating AI response...', 'info');
        });
        
        connection.on('ErrorMessage', (error) => {
            showSystemMessage(error, 'error');
        });
    }

    async function createNewSession() {
        const userToken = document.getElementById('userToken').value;
        const modelId = document.getElementById('modelSelect').value;
        const agentId = getSelectedAgentId();
        const enableThinking = document.getElementById('enableThinking').checked;

        if (!userToken) {
            showSystemMessage('Enter Auth Token first', 'error');
            return;
        }

        if (!modelId && !agentId) {
            showSystemMessage('Select either an AI Model or an AI Agent', 'error');
            return;
        }

        try {
            showSystemMessage('Creating new session...', 'info');
            const response = await fetch('/api/Chat/Create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                },
                body: JSON.stringify({ 
                    modelId: agentId ? null : modelId, 
                    folderId: null,
                    aiAgentId: agentId,
                    enableThinking: enableThinking
                })
            });

            if (response.ok) {
                const result = await response.json();
                document.getElementById('chatSessionId').value = result.id;
                showSystemMessage(`New session created: ${result.id}`, 'success');
                joinChatSession();
            } else {
                const errorText = await response.text();
                showSystemMessage(`Failed to create session: ${errorText}`, 'error');
            }
        } catch (error) {
            showSystemMessage('Error creating session.', 'error');
            console.error(error);
        }
    }

    function getSelectedAgentId() {
        const agentRadios = document.querySelectorAll('input[name="agent"]');
        for (const radio of agentRadios) {
            if (radio.checked && radio.value !== 'none') {
                return radio.value;
            }
        }
        return null;
    }

    async function loadChatHistory(chatSessionId, userToken) {
        try {
            const response = await fetch(`/api/Chat/${chatSessionId}`, {
                headers: { 'Authorization': `Bearer ${userToken}` }
            });
            if (response.ok) {
                const result = await response.json();
                messagesContainer.innerHTML = '';
                if (result.messages?.length) {
                    result.messages.forEach(msg => {
                        addMessageToChat(msg.content, msg.isFromAi, msg.id, msg.createdAt);
                        if (!msg.isFromAi) lastUserMessageId = msg.id;
                    });
                    addCodeBlockActions();
                } else {
                    showSystemMessage('No messages yet. Start chatting!', 'info');
                }
            } else {
                showSystemMessage('Failed to load history', 'error');
            }
        } catch (error) {
            showSystemMessage('Error loading history', 'error');
            console.error(error);
        }
    }

    function sendMessage() {
        const content = messageInput.value.trim();
        const chatSessionId = document.getElementById('chatSessionId').value;

        if (!connection || !content || !chatSessionId) return;

        messageInput.disabled = true;
        sendButton.disabled = true;
        messageInput.value = '';
        messageInput.style.height = 'auto';

        connection.invoke('SendMessage', chatSessionId, content)
            .catch(err => {
                showSystemMessage('Failed to send message', 'error');
                console.error(err);
            })
            .finally(() => {
                messageInput.disabled = false;
                sendButton.disabled = false;
                messageInput.focus();
            });
    }

    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function editMessage(messageId) {
        const messageElement = document.getElementById(`message-${messageId}`);
        if (!messageElement) return;
        
        const contentElement = messageElement.querySelector('.message-content');
        const currentContent = contentElement.textContent.trim();
        
        // Create edit form
        const editContainer = document.createElement('div');
        editContainer.className = 'edit-container';
        
        const editArea = document.createElement('textarea');
        editArea.value = currentContent;
        editArea.className = 'form-control mb-2';
        editArea.style.width = '100%';
        editArea.style.borderRadius = '0.5rem';
        editArea.style.padding = '0.75rem';
        editArea.style.color = '#d9e1e8';
        editArea.style.backgroundColor = '#252b31';
        editArea.style.border = '1px solid #455a64';
        editArea.style.marginBottom = '10px';
        editArea.rows = 3;
        
        const buttonGroup = document.createElement('div');
        buttonGroup.style.display = 'flex';
        buttonGroup.style.gap = '10px';
        
        const saveButton = document.createElement('button');
        saveButton.textContent = 'Save';
        saveButton.className = 'btn-primary';
        saveButton.style.flex = '1';
        
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'Cancel';
        cancelButton.className = 'btn-secondary';
        cancelButton.style.flex = '1';
        
        buttonGroup.appendChild(saveButton);
        buttonGroup.appendChild(cancelButton);
        
        editContainer.appendChild(editArea);
        editContainer.appendChild(buttonGroup);
        
        // Hide original content and show edit form
        contentElement.style.display = 'none';
        messageElement.insertBefore(editContainer, contentElement.nextSibling);
        
        // Focus on the textarea
        editArea.focus();
        
        // Handle save action
        saveButton.addEventListener('click', () => {
            const newContent = editArea.value.trim();
            if (!newContent) {
                showSystemMessage('Message cannot be empty', 'error');
                return;
            }
            
            if (newContent !== currentContent) {
                const chatSessionId = document.getElementById('chatSessionId').value;
                
                // Disable buttons while saving
                saveButton.disabled = true;
                cancelButton.disabled = true;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                
                connection.invoke('EditMessage', chatSessionId, messageId, newContent)
                    .then(() => {
                        // Remove edit form
                        messageElement.removeChild(editContainer);
                        contentElement.textContent = newContent;
                        contentElement.style.display = 'block';
                    })
                    .catch(err => {
                        showSystemMessage('Failed to edit message: ' + err, 'error');
                        saveButton.disabled = false;
                        cancelButton.disabled = false;
                        saveButton.textContent = 'Save';
                    });
            } else {
                // No changes, just cancel
                messageElement.removeChild(editContainer);
                contentElement.style.display = 'block';
            }
        });
        
        // Handle cancel action
        cancelButton.addEventListener('click', () => {
            messageElement.removeChild(editContainer);
            contentElement.style.display = 'block';
        });
        
        // Handle keyboard shortcuts (Enter to save, Esc to cancel)
        editArea.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                e.preventDefault();
                saveButton.click();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelButton.click();
            }
        });
    }
    
    function regenerateMessage(messageId) {
        // First, find the AI message
        const aiMessageElement = document.getElementById(`message-${messageId}`);
        if (!aiMessageElement || !aiMessageElement.classList.contains('ai')) {
            showSystemMessage('Cannot regenerate: not an AI message', 'error');
            return;
        }
        
        // Confirm regeneration
        if (!confirm('Are you sure you want to regenerate this AI response?')) {
            return;
        }
        
        const chatSessionId = document.getElementById('chatSessionId').value;
        
        // Show loading indicator
        const contentDiv = aiMessageElement.querySelector('.message-content');
        const originalContent = contentDiv.innerHTML;
        contentDiv.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div> Regenerating response...</div>';
        
        // Call the regenerate function through SignalR
        connection.invoke('RegenerateMessage', chatSessionId, messageId)
            .catch(err => {
                showSystemMessage('Failed to regenerate message: ' + err, 'error');
                contentDiv.innerHTML = originalContent;
            });
    }
    
    function copyMessage(messageId) {
        const messageElement = document.getElementById(`message-${messageId}`);
        if (!messageElement) return;
        
        const contentElement = messageElement.querySelector('.message-content');
        const textToCopy = contentElement.textContent.trim();
        
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                showSystemMessage('Message copied to clipboard', 'success');
                
                // Flash effect for the copy button
                const copyButton = messageElement.querySelector('.message-actions button:nth-child(2)');
                if (copyButton) {
                    copyButton.innerHTML = '<i class="fas fa-check"></i>';
                    setTimeout(() => {
                        copyButton.innerHTML = '<i class="fas fa-copy"></i>';
                    }, 2000);
                }
            })
            .catch(err => {
                showSystemMessage('Failed to copy: ' + err, 'error');
            });
    }

    function updateMessageChunk(messageId, chunk) {
        let messageElement = document.getElementById(`message-${messageId}`);
        if (!messageElement) {
            addMessageToChat('', true, messageId);
            messageElement = document.getElementById(`message-${messageId}`);
        }
        const contentDiv = messageElement.querySelector('.message-content');
        contentDiv.innerHTML += marked.parse(chunk);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function appendToMessage(messageId, text) {
        const messageElement = document.getElementById(`message-${messageId}`);
        if (messageElement) {
            const contentDiv = messageElement.querySelector('.message-content');
            contentDiv.innerHTML += marked.parse(text);
        }
    }

    function updateStopButton(show) {
        stopButton.style.display = show ? 'inline-block' : 'none';
        stopButton.disabled = !show;
        if (show) stopButton.classList.add('animation-pulse');
        else stopButton.classList.remove('animation-pulse');
    }

    function showSystemMessage(message, type = 'error') {
        const systemMessage = document.createElement('div');
        systemMessage.className = `system-message ${type}-message`;
        
        let icon = 'fas fa-exclamation-circle';
        if (type === 'success') icon = 'fas fa-check-circle';
        if (type === 'info') icon = 'fas fa-info-circle';
        
        systemMessage.innerHTML = `<i class="${icon}"></i> ${message}`;
        messagesContainer.appendChild(systemMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        setTimeout(() => {
            systemMessage.style.opacity = '0';
            systemMessage.style.transition = 'opacity 0.5s';
            setTimeout(() => systemMessage.remove(), 500);
        }, 5000);
    }

    function enableChatInterface() {
        messageInput.disabled = false;
        sendButton.disabled = false;
        messageInput.focus();
        if (isReceivingResponse) updateStopButton(true);
    }

    function disableChatInterface() {
        messageInput.disabled = true;
        sendButton.disabled = true;
        updateStopButton(false);
    }

    async function toggleThinking(enable) {
        const chatSessionId = document.getElementById('chatSessionId').value;
        const userToken = localStorage.getItem('userToken') || '';
        
        if (!chatSessionId) {
            showSystemMessage('No active chat session', 'error');
            return;
        }
        
        try {
            const response = await fetch(`/api/Chat/ToggleThinking/${chatSessionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                },
                body: JSON.stringify({ enable })
            });
            
            if (response.ok) {
                showSystemMessage(`Thinking mode ${enable ? 'enabled' : 'disabled'}`, 'success');
            } else {
                showSystemMessage('Failed to update thinking mode', 'error');
            }
        } catch (error) {
            console.error('Error toggling thinking mode:', error);
            showSystemMessage('Error updating thinking mode', 'error');
        }
    }
    
    // Add event listener for thinking checkbox
    document.getElementById('enableThinking').addEventListener('change', function() {
        if (document.getElementById('chatSessionId').value) {
            toggleThinking(this.checked);
        }
    });

    // File upload functionality
    async function uploadFile() {
        const file = document.getElementById('fileUpload').files[0];
        const chatSessionId = document.getElementById('chatSessionId').value;
        const userToken = localStorage.getItem('userToken') || '';
        
        if (!file || !chatSessionId || !lastUserMessageId) {
            showSystemMessage('Cannot upload file: Missing chat session or message', 'error');
            return;
        }
        
        // Create form data
        const formData = new FormData();
        formData.append('file', file);
        
        try {
            showSystemMessage(`Uploading file: ${file.name}...`, 'info');
            
            const response = await fetch(`/api/Files/Upload/${lastUserMessageId}`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${userToken}`
                },
                body: formData
            });
            
            if (response.ok) {
                const result = await response.json();
                showSystemMessage(`File uploaded: ${result.fileName}`, 'success');
                
                // Notify other clients through SignalR
                if (connection) {
                    connection.invoke('NotifyFileUploaded', chatSessionId, lastUserMessageId, result.id)
                        .catch(err => console.error('Error notifying about file upload:', err));
                }
                
                // Reset file input
                document.getElementById('fileUpload').value = '';
            } else {
                showSystemMessage('Failed to upload file', 'error');
            }
        } catch (error) {
            console.error('File upload error:', error);
            showSystemMessage('Error uploading file', 'error');
        }
    }
    
    function addFileAttachmentToMessage(messageId, fileAttachment) {
        const messageElement = document.getElementById(`message-${messageId}`);
        if (!messageElement) return;
        
        let attachmentsContainer = messageElement.querySelector('.message-attachments');
        if (!attachmentsContainer) {
            attachmentsContainer = document.createElement('div');
            attachmentsContainer.className = 'message-attachments';
            messageElement.appendChild(attachmentsContainer);
        }
        
        const attachment = document.createElement('div');
        attachment.className = 'attachment';
        attachment.id = `attachment-${fileAttachment.id}`;
        
        // Determine icon based on file type
        let icon = 'fa-file';
        switch (fileAttachment.fileType) {
            case 'Image': icon = 'fa-file-image'; break;
            case 'Video': icon = 'fa-file-video'; break;
            case 'Audio': icon = 'fa-file-audio'; break;
            case 'PDF': icon = 'fa-file-pdf'; break;
            case 'Document': icon = 'fa-file-alt'; break;
        }
        
        attachment.innerHTML = `
            <span class="attachment-icon"><i class="fas ${icon}"></i></span>
            <div class="attachment-info">
                <div class="attachment-name">${fileAttachment.fileName}</div>
                <div class="attachment-size">${formatFileSize(fileAttachment.fileSize)}</div>
            </div>
            <div class="attachment-actions">
                <button class="attachment-btn" onclick="downloadFile('${fileAttachment.id}', '${fileAttachment.fileName}')">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        `;
        
        attachmentsContainer.appendChild(attachment);
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
        else if (bytes < 1073741824) return (bytes / 1048576).toFixed(1) + ' MB';
        else return (bytes / 1073741824).toFixed(1) + ' GB';
    }
    
    function downloadFile(fileId, fileName) {
        const userToken = localStorage.getItem('userToken') || '';
        const url = `/api/Files/${fileId}`;
        
        // Create a temporary link and click it to download
        const a = document.createElement('a');
        a.href = url;
        a.setAttribute('download', fileName);
        a.setAttribute('target', '_blank');
        
        // Add authorization header via fetch and then download as blob
        fetch(url, {
            headers: {
                'Authorization': `Bearer ${userToken}`
            }
        })
        .then(response => response.blob())
        .then(blob => {
            const objectUrl = URL.createObjectURL(blob);
            a.href = objectUrl;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(objectUrl);
        })
        .catch(error => {
            console.error('Error downloading file:', error);
            showSystemMessage('Error downloading file', 'error');
        });
    }

    function addCodeBlockActions() {
        // Find all pre>code elements and add copy buttons
        document.querySelectorAll('.message-content pre > code').forEach((codeBlock, index) => {
            const pre = codeBlock.parentNode;
            if (pre.querySelector('.copy-button')) return; // Skip if already has button
            
            // Add a container to position things properly
            pre.style.position = 'relative';
            
            // Try to detect language
            const className = codeBlock.className;
            let language = 'text';
            if (className) {
                const match = className.match(/language-(\w+)/);
                if (match) language = match[1];
            }
            
            // Add language label
            const languageLabel = document.createElement('span');
            languageLabel.className = 'language-label';
            languageLabel.textContent = language;
            pre.appendChild(languageLabel);
            
            // Add copy button
            const copyButton = document.createElement('button');
            copyButton.className = 'copy-button';
            copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
            copyButton.onclick = function() {
                const code = codeBlock.textContent;
                navigator.clipboard.writeText(code).then(() => {
                    copyButton.innerHTML = '<i class="fas fa-check"></i> Copied!';
                    setTimeout(() => {
                        copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    copyButton.innerHTML = '<i class="fas fa-times"></i> Error';
                    setTimeout(() => {
                        copyButton.innerHTML = '<i class="fas fa-copy"></i> Copy';
                    }, 2000);
                });
            };
            pre.appendChild(copyButton);
        });
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function stopCurrentResponse() {
        if (!isReceivingResponse || !currentResponseMessageId) return;

        stopButton.disabled = true;
        fetch(`/api/chat/StopResponse/${currentResponseMessageId}`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('userToken')}` }
        })
            .then(response => {
                if (!response.ok) throw new Error('Failed to stop response');
            })
            .catch(() => showSystemMessage('Error stopping response', 'error'))
            .finally(() => stopButton.disabled = false);
    }

    function addMessageToChat(content, isFromAi, messageId, timestamp = null) {
        const messageElement = document.createElement('div');
        messageElement.className = `message ${isFromAi ? 'ai' : 'user'}`;
        messageElement.id = `message-${messageId}`;

        const formattedContent = isFromAi ? marked.parse(content) : escapeHtml(content);
        const time = timestamp ? new Date(timestamp) : new Date();
        const formattedTime = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

        let actionButtons = '';
        
        if (!isFromAi) {
            // User message actions
            actionButtons = `
                <div class="message-actions">
                    <button class="action-button" onclick="editMessage('${messageId}')" title="Edit Message">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            `;
        } else {
            // AI message actions
            actionButtons = `
                <div class="message-actions">
                    <button class="action-button" onclick="regenerateMessage('${messageId}')" title="Regenerate Response">
                        <i class="fas fa-redo-alt"></i>
                    </button>
                    <button class="action-button" onclick="copyMessage('${messageId}')" title="Copy Message">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            `;
        }

        messageElement.innerHTML = `
            ${actionButtons}
            <div class="message-content">${formattedContent}</div>
            <div class="message-attachments"></div>
            <div class="message-info">
                <span class="message-id">${messageId.substring(0, 8)}</span>
                <span class="timestamp">${formattedTime}</span>
            </div>
        `;
        messagesContainer.appendChild(messageElement);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function updateThinkingChunk(messageId, chunk) {
        if (currentThinkingMessageId !== messageId) {
            currentThinkingMessageId = messageId;
            const thinkingElement = document.createElement('div');
            thinkingElement.className = 'thinking';
            thinkingElement.id = `thinking-${messageId}`;
            thinkingElement.innerHTML = `
                <div class="thinking-badge"><i class="fas fa-brain"></i> Thinking Process</div>
                <div class="message-content">${marked.parse(chunk)}</div>
                <div class="message-info">
                    <span class="message-id">Thinking trace for ${messageId.substring(0, 8)}</span>
                    <span class="timestamp">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
            `;
            messagesContainer.appendChild(thinkingElement);
            addCodeBlockActions(); // Add code block actions to any code in thinking
        } else {
            const thinkingElement = document.getElementById(`thinking-${messageId}`);
            if (thinkingElement) {
                const contentDiv = thinkingElement.querySelector('.message-content');
                const newContent = marked.parse(chunk);
                contentDiv.innerHTML += newContent;
                addCodeBlockActions(); // Update code block actions after content change
            }
        }
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
</script>
</body>
</html>