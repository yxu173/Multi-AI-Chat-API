<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-AI-Chat – Test Client</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@7.0.12/dist/browser/signalr.min.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 2rem auto; }
        #messages { height:300px; overflow:auto; border:1px solid #ccc; padding:0.5rem; white-space:pre-wrap; }
        .me { color: royalblue; }
        .ai { color: seagreen; }
        .sys { color: #555; }
        #tokenUsage { margin-top:0.5rem; font-size:0.9rem; color:#666; }
    </style>
</head>
<body>
<h2>Test Multi-AI-Chat</h2>
<div>
    <label>Token:<br><input id="token" style="width:100%"></label><br><br>
    <label>Chat Session Id:<br><input id="chatId" style="width:100%"></label><br><br>
    <button id="btnConnect">Connect</button>
</div>
<hr>
<div id="chatSection" style="display:none">
    <div id="messages"></div>
    <div id="tokenUsage"></div>
    <textarea id="txtMessage" placeholder="Type message..." style="width:100%; height:80px;"></textarea><br>
    <input type="file" id="fileInput" multiple><br><br>
    <button id="btnSend">Send</button>
</div>
<script>
    const el = id => document.getElementById(id);
    function appendMsg(text, cls='sys') {
        const div = document.createElement('div');
        div.className = cls;
        div.textContent = text;
        el('messages').appendChild(div);
        el('messages').scrollTop = el('messages').scrollHeight;
    }
    let connection;
    el('btnConnect').onclick = async () => {
        const token = el('token').value.trim();
        const chatId = el('chatId').value.trim();
        if (!token || !chatId) return alert('Token and Chat-Id are required');
        connection = new signalR.HubConnectionBuilder()
            .withUrl('/chatHub',{accessTokenFactory:()=>token})
            .withAutomaticReconnect()
            .configureLogging(signalR.LogLevel.Information)
            .build();
        connection.on('ReceiveChatHistory', hist => {
            appendMsg('--- History ---','sys');
            (hist.messages||[]).forEach(m=>{
                appendMsg((m.isFromAi?'AI':'You')+': '+m.content, m.isFromAi?'ai':'me');
            });
        });
        connection.on('ReceiveMessageChunk', (msgId, chunk) => {
            let last = el('messages').querySelector('.ai:last-child');
            if (!last) { appendMsg('AI:','ai'); last = el('messages').querySelector('.ai:last-child'); }
            last.textContent = 'AI: '+(last.textContent.slice(4)+chunk)+'▌';
        });
        connection.on('ResponseCompleted', ()=> {
            const last = el('messages').querySelector('.ai:last-child');
            if(last) last.textContent = last.textContent.replace(/▌$/,'');
        });
        connection.on('TokenUsageUpdated', info => {
            el('tokenUsage').textContent = `Tokens in:${info.inputTokens}, out:${info.outputTokens}, total:${info.totalTokens} (cost $${info.totalCost})`;
        });
        connection.on('ReceiveMessage', msg=>appendMsg('AI: '+msg.content,'ai'));
        connection.onclose(err=>appendMsg('Disconnected: '+(err?.message||''),'sys'));
        try {
            await connection.start();
            appendMsg('Connected!','sys');
            await connection.invoke('JoinChatSession',chatId);
            el('chatSection').style.display='';
        } catch(e){ alert('Error: '+e); console.error(e); }
    };
    async function uploadFiles(files,token){
        const ids=[];
        for(const f of files){
            const form = new FormData();
            form.append('File',f);
            const res = await fetch('/api/file/upload',{method:'POST',headers:{"Authorization":"Bearer "+token},body:form});
            if(!res.ok){ appendMsg(`Upload failed: ${f.name}`,'sys'); continue; }
            const data=await res.json(); ids.push(data.id);
        }
        return ids;
    }
    el('btnSend').onclick = async ()=>{
        const txt = el('txtMessage').value.trim();
        const files = el('fileInput').files;
        if(!connection||(!txt&&files.length==0)) return;
        let atts=[];
        if(files.length) atts = await uploadFiles(files,el('token').value.trim());
        try {
            if(atts.length)
                await connection.invoke('SendMessageWithAttachments',
                    el('chatId').value.trim(),
                    txt,
                    atts,
                    false,
                    null,
                    null,
                    null,
                    null,
                    null);
            else
                await connection.invoke('SendMessage',
                    el('chatId').value.trim(),
                    txt,
                    false,
                    null,
                    null,
                    null,
                    null,
                    null);
            appendMsg('You: '+txt,'me');
            el('txtMessage').value='';
            el('fileInput').value='';
        }catch(e){ appendMsg('Send error: '+e,'sys'); }
    };
</script>
</body>
</html>